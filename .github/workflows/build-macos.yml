name: build whisper.cpp (macOS arm64)

on:
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure (Release, arm64)
        run: |
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=11.0 \
            -DWHISPER_BUILD_SERVER=ON \
            -DGGML_METAL=ON \
            -DGGML_METAL_EMBED_LIBRARY=ON \
            -DBUILD_SHARED_LIBS=OFF

      - name: Build (whisper-cli + server)
        run: |
          set -eux
          cmake --build build --config Release --target whisper-cli

          # server のターゲット名が揺れることがあるため両方試す
          cmake --build build --config Release --target whisper-server \
            || cmake --build build --config Release --target whisper-whisper-server

          ls -lah build/bin

      - name: Bundle artifacts
        run: |
          set -eux
          rm -rf dist
          mkdir -p dist/bin

          # CLI
          cp -v build/bin/whisper-cli dist/bin/whisper-cli

          # Server: どちらか存在する方を拾って "whisper-server" に正規化
          if [ -f build/bin/whisper-server ]; then
            cp -v build/bin/whisper-server dist/bin/whisper-server
          elif [ -f build/bin/whisper-whisper-server ]; then
            cp -v build/bin/whisper-whisper-server dist/bin/whisper-server
          else
            echo "ERROR: server binary not found in build/bin" >&2
            exit 1
          fi

          # ここに models を同梱したいなら、別途 dist/models にコピーする
          # mkdir -p dist/models && cp -v models/*.bin dist/models/

          tar -czf whisper-macos-arm64.tgz -C dist .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: whisper-macos-arm64
          path: whisper-macos-arm64.tgz
